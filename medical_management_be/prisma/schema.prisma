generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                 @id @default(uuid())
  phoneNumber            String                 @unique
  password               String
  fullName               String
  role                   UserRole               @default(PATIENT)
  status                 UserStatus             @default(ACTIVE)
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  deletedAt              DateTime?
  createdBy              String?
  majorDoctorId          String?
  adherenceLogs          AdherenceLog[]
  alertsAsDoctor         Alert[]                @relation("DoctorAlerts")
  alertsAsPatient        Alert[]                @relation("PatientAlerts")
  medicalHistory         PatientMedicalHistory?
  profile                PatientProfile?
  prescriptionsAsDoctor  Prescription[]         @relation("DoctorPrescriptions")
  prescriptionsAsPatient Prescription[]         @relation("PatientPrescriptions")
  createdByUser          User?                  @relation("CreatedBy", fields: [createdBy], references: [id])
  createdPatients        User[]                 @relation("CreatedBy")
  majorDoctor            MajorDoctorTable?      @relation(fields: [majorDoctorId], references: [id])
}

model PatientProfile {
  id        String    @id @default(uuid())
  userId    String    @unique
  gender    Gender?
  birthDate DateTime?
  address   String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PatientMedicalHistory {
  id                 String   @id @default(uuid())
  patientId          String   @unique
  conditions         String[] @default([])
  allergies          String[] @default([])
  surgeries          String[] @default([])
  familyHistory      String?
  lifestyle          String?
  currentMedications String[] @default([])
  notes              String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  extras             Json?
  patient            User     @relation(fields: [patientId], references: [id], onDelete: Cascade)
}

model Medication {
  id                String             @id @default(uuid())
  name              String
  strength          String?
  form              String?
  unit              String?
  description       String?
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  prescriptionItems PrescriptionItem[]
}

model Prescription {
  id        String             @id @default(uuid())
  patientId String
  doctorId  String
  status    PrescriptionStatus @default(ACTIVE)
  startDate DateTime           @default(now())
  endDate   DateTime?
  notes     String?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  logs      AdherenceLog[]
  alerts    Alert[]
  doctor    User               @relation("DoctorPrescriptions", fields: [doctorId], references: [id], onDelete: Cascade)
  patient   User               @relation("PatientPrescriptions", fields: [patientId], references: [id], onDelete: Cascade)
  items     PrescriptionItem[]
}

model PrescriptionItem {
  id              String         @id @default(uuid())
  prescriptionId  String
  medicationId    String
  dosage          String
  frequencyPerDay Int
  timesOfDay      String[]
  durationDays    Int
  route           String?
  instructions    String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  logs            AdherenceLog[]
  medication      Medication     @relation(fields: [medicationId], references: [id])
  prescription    Prescription   @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
}

model AdherenceLog {
  id                 String            @id @default(uuid())
  prescriptionId     String
  prescriptionItemId String?
  patientId          String
  takenAt            DateTime
  status             AdherenceStatus
  amount             String?
  notes              String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  patient            User              @relation(fields: [patientId], references: [id], onDelete: Cascade)
  prescription       Prescription      @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  prescriptionItem   PrescriptionItem? @relation(fields: [prescriptionItemId], references: [id])
}

model Alert {
  id             String        @id @default(uuid())
  prescriptionId String?
  patientId      String
  doctorId       String?
  type           AlertType
  message        String
  resolved       Boolean       @default(false)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  doctor         User?         @relation("DoctorAlerts", fields: [doctorId], references: [id])
  patient        User          @relation("PatientAlerts", fields: [patientId], references: [id], onDelete: Cascade)
  prescription   Prescription? @relation(fields: [prescriptionId], references: [id])
}

model MajorDoctorTable {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  nameEn      String?
  description String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  doctors     User[]
}

enum UserRole {
  ADMIN
  DOCTOR
  PATIENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum MajorDoctor {
  DINH_DUONG
  TAM_THAN
  TIM_MACH
  NOI_TIET
  NGOAI_KHOA
  PHU_SAN
  NHI_KHOA
  MAT
  TAI_MUI_HONG
  DA_LIEU
  XUONG_KHOP
  THAN_KINH
  UNG_BUOU
  HO_HAP
  TIEU_HOA
  THAN_TIET_NIEU
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum PrescriptionStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum AdherenceStatus {
  TAKEN
  MISSED
  SKIPPED
}

enum AlertType {
  MISSED_DOSE
  LOW_ADHERENCE
  OTHER
}
